<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Covid-19 Detection | Madan Baduwal </title> <meta name="author" content="Madan Baduwal"> <meta name="description" content="🦠 🏥 A computer vision system is designed to analyze chest X-ray images and determine whether a person is positive or negative for COVID-19."> <meta name="keywords" content="Madan Baduwal, Cognitive neuroscience, Deep Learning(Multimodal Learning, Generative AI, LLM), Computer Vision, Natural Language Processing,Software Engineering, and Robotics."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://madanbaduwal.github.io/blog/2020/covid19detection/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Madan Baduwal </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/_pages/meeting/">meeting </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Covid-19 Detection</h1> <p class="post-meta"> December 22, 2020 </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/covid19"> <i class="fa-solid fa-hashtag fa-sm"></i> covid19</a>   <a href="/blog/tag/cnn"> <i class="fa-solid fa-hashtag fa-sm"></i> CNN</a>   <a href="/blog/tag/computer"> <i class="fa-solid fa-hashtag fa-sm"></i> computer</a>   <a href="/blog/tag/vision"> <i class="fa-solid fa-hashtag fa-sm"></i> vision</a>     ·   <a href="/blog/category/ai"> <i class="fa-solid fa-tag fa-sm"></i> AI</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This assignment focuses on creating a machine learning model to classify COVID-19 lung X-ray images stored in Google Drive. Our objective is to perform binary classification of COVID-19 lung images from Kaggle datasets.</p> <p>Mount drive</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Mount drive
</span><span class="kn">from</span> <span class="n">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="p">.</span><span class="nf">mount</span><span class="p">(</span><span class="sh">'</span><span class="s">/drive</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <h1 id="dataset-description">Dataset Description</h1> <hr> <p>Here, we are going to use the raw <code class="language-plaintext highlighter-rouge">COVID-19 Patients Lungs X Ray Images 10000</code> data from kaggle.</p> <p><strong>License</strong> Data files © Original Authors</p> <p><strong>Citation:</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Kaggle,
  url       = {https://www.kaggle.com/nabeelsajid917/covid-19-x-ray-10000-images?select=dataset}
}
</code></pre></div></div> <h2 id="load-raw-provided-dataset">Load raw (provided) Dataset</h2> <hr> <p>Here we have provided dataset :</p> <p>Corona positive : 70</p> <p>Corona negative : 28</p> <h1 id="data-augumentation">Data Augumentation</h1> <hr> <p>We have provided 70 positive images and 28 negatives. If we apply CNN we need lots of data set so, we need data augmentation to increase the training sample. Augmentation is the process of increasing training samples by flipping, color modification, cropping, rotation, noise injection, and random erasing.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="n">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="n">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">img_to_array</span>
<span class="kn">from</span> <span class="n">imutils</span> <span class="kn">import</span> <span class="n">paths</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">data_augumentation</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    Augument the give data.

    ## Parameters:
      input_path (str) : input files path
      output_path (str) : output files path
    </span><span class="sh">'''</span>
    <span class="n">imagePaths</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">paths</span><span class="p">.</span><span class="nf">list_images</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">imagePath</span> <span class="ow">in</span> <span class="n">imagePaths</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">imagePath</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  

    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] loading example image...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="nf">img_to_array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">aug</span> <span class="o">=</span> <span class="nc">ImageDataGenerator</span><span class="p">(</span>
            <span class="n">rotation_range</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">zoom_range</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="n">width_shift_range</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="n">height_shift_range</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="n">shear_range</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="n">horizontal_flip</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
            <span class="n">fill_mode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nearest</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] generating images...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">imageGen</span> <span class="o">=</span> <span class="n">aug</span><span class="p">.</span><span class="nf">flow</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">save_to_dir</span> <span class="o">=</span> <span class="n">output_path</span><span class="p">,</span>
            <span class="n">save_prefix</span> <span class="o">=</span> <span class="sh">"</span><span class="s">image</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">save_format</span> <span class="o">=</span> <span class="sh">"</span><span class="s">jpg</span><span class="sh">"</span><span class="p">)</span>  
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">imageGen</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></div></div> <p>Covid postive and negative data augumentation</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Paths</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">/drive/My Drive/covid/raw/covid</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">/drive/My Drive/covid/processed/covid</span><span class="sh">"</span><span class="p">),</span>
       <span class="p">(</span><span class="sh">"</span><span class="s">/drive/My Drive/covid/raw/normal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">/drive/My Drive/covid/processed/normal</span><span class="sh">"</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Paths</span><span class="p">:</span>
  <span class="nf">data_augumentation</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div> <p>Augmented data and save it into the processed folder.</p> <h1 id="load-augumented-processed-datasets">Load augumented (processed) Datasets</h1> <p>Here after augumentation we had saved augumented dataset into processed folder. Load augumented(processed) dataset.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span>  <span class="nf">get_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    Get data from given path.

    ## Parameters:
      input_path (str) : input files path

    ## Returns
       data (array) : image array
       labels (array) : label array
    </span><span class="sh">'''</span>
    <span class="n">imagePaths</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">paths</span><span class="p">.</span><span class="nf">list_images</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">imagePath</span> <span class="ow">in</span> <span class="n">imagePaths</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">imagePath</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">labels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">labels</span>
</code></pre></div></div> <h1 id="data-preprocessing">Data preprocessing</h1> <hr> <p>In this section, you will complete a <code class="language-plaintext highlighter-rouge">data_preprocessing</code> function to clean the data and labels.</p> <ul> <li>Normalize all data dividing by 255.(i.e. convert image into binary image)</li> <li>Binarize the label using <code class="language-plaintext highlighter-rouge">LabelBinarizer()</code> </li> <li>Convert binarizerd labels into categorical vectors.</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelBinarizer</span>

<span class="k">def</span> <span class="nf">data_preprocessing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    Preprocess the given data.

    ## Parameters:
      data (array) : input image dataset
      labels (array) : array of labels

    ## Returns
       data (array) : processed array of images
       labels (array) : processd array of labels
    </span><span class="sh">'''</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="nc">LabelBinarizer</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">lb</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nf">to_categorical</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">lb</span>
</code></pre></div></div> <h1 id="train-test-split">Train-Test split</h1> <hr> <p>We use sklearn <code class="language-plaintext highlighter-rouge">train_test_split</code> function to split data into train and test.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>


<span class="k">def</span> <span class="nf">data_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span>

    <span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">testX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">testY</span><span class="p">)</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">testX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">testY</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/drive/My Drive/covid/processed</span><span class="sh">"</span>
<span class="n">data</span><span class="p">,</span><span class="n">labels</span> <span class="o">=</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
<span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">lb</span> <span class="o">=</span> <span class="nf">data_preprocessing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
<span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">testX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">testY</span><span class="p">)</span> <span class="o">=</span> <span class="nf">data_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
</code></pre></div></div> <h1 id="create-models">Create models</h1> <hr> <h2 id="vgg16">VGG16</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">VGG16</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">AveragePooling2D</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="n">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>


<span class="k">class</span> <span class="nc">Model_VGG16</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">int_lr</span><span class="p">,</span><span class="n">epochs</span><span class="p">,</span><span class="n">bs</span><span class="p">):</span>

        <span class="n">self</span><span class="p">.</span><span class="n">int_lr</span> <span class="o">=</span> <span class="n">int_lr</span> <span class="c1"># learning rate
</span>        <span class="n">self</span><span class="p">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span>
        <span class="n">baseModel</span> <span class="o">=</span> <span class="nc">VGG16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="sh">"</span><span class="s">imagenet</span><span class="sh">"</span><span class="p">,</span> <span class="n">include_top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">input_tensor</span><span class="o">=</span><span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

        <span class="n">headModel</span> <span class="o">=</span> <span class="n">baseModel</span><span class="p">.</span><span class="n">output</span>
        <span class="n">headModel</span> <span class="o">=</span> <span class="nc">AveragePooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))(</span><span class="n">headModel</span><span class="p">)</span>
        <span class="n">headModel</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">flatten</span><span class="sh">"</span><span class="p">)(</span><span class="n">headModel</span><span class="p">)</span>
        <span class="n">headModel</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">"</span><span class="s">relu</span><span class="sh">"</span><span class="p">)(</span><span class="n">headModel</span><span class="p">)</span>
        <span class="n">headModel</span> <span class="o">=</span> <span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">headModel</span><span class="p">)</span>
        <span class="n">headModel</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">"</span><span class="s">softmax</span><span class="sh">"</span><span class="p">)(</span><span class="n">headModel</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">baseModel</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">headModel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">baseModel</span><span class="p">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] compiling model...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="nc">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">int_lr</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">int_lr</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">epochs</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="sh">"</span><span class="s">binary_crossentropy</span><span class="sh">"</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span><span class="n">testX</span><span class="p">,</span><span class="n">testY</span><span class="p">):</span>
        <span class="n">trainAug</span> <span class="o">=</span> <span class="nc">ImageDataGenerator</span><span class="p">(</span>
            <span class="n">rotation_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">fill_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">nearest</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] training head...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">History</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">fit_generator</span><span class="p">(</span>
            <span class="n">trainAug</span><span class="p">.</span><span class="nf">flow</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">bs</span><span class="p">),</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">trainX</span><span class="p">)</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">bs</span><span class="p">,</span>
            <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="n">testY</span><span class="p">),</span>
            <span class="n">validation_steps</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">testX</span><span class="p">)</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">bs</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">epochs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">History</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">testX</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">bs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] saving COVID-19 detector model...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">model.h5</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h1 id="model-evaluation">Model evaluation</h1> <hr> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="k">def</span> <span class="nf">model_evaluation</span><span class="p">(</span><span class="n">History</span><span class="p">,</span> <span class="n">predIdxs</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span><span class="n">testX</span><span class="p">,</span><span class="n">testY</span><span class="p">):</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[INFO] evaluating network...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">predIdxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">predIdxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">classification_report</span><span class="p">(</span><span class="n">testY</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">predIdxs</span><span class="p">,</span>
                                <span class="n">target_names</span><span class="o">=</span><span class="n">lb</span><span class="p">.</span><span class="n">classes_</span><span class="p">))</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="nf">confusion_matrix</span><span class="p">(</span><span class="n">testY</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">predIdxs</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">specificity</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">acc: {:.4f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">sensitivity: {:.4f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">specificity: {:.4f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">specificity</span><span class="p">))</span>
    <span class="c1"># plot the training loss and accuracy
</span>    <span class="n">N</span> <span class="o">=</span> <span class="n">EPOCHS</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">"</span><span class="s">ggplot</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">History</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">train_loss</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># plt.plot(np.arange(0, N), History.history["val_loss"], label="val_loss")
</span>    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">History</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">train_acc</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># plt.plot(np.arange(0, N), History.history["val_accuracy"], label="val_acc")
</span>    <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Training Loss and Accuracy on COVID-19 Dataset</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Epoch #</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Loss/Accuracy</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">lower left</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h1 id="ml-pipeline">ML pipeline</h1> <hr> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INIT_LR</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">BS</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">model_vgg16</span> <span class="o">=</span> <span class="nc">Model_VGG16</span><span class="p">(</span><span class="n">INIT_LR</span><span class="p">,</span><span class="n">EPOCHS</span><span class="p">,</span><span class="n">BS</span><span class="p">)</span>
<span class="n">History</span> <span class="o">=</span> <span class="n">model_vgg16</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span><span class="n">testX</span><span class="p">,</span><span class="n">testY</span><span class="p">)</span>
<span class="n">predIdxs</span> <span class="o">=</span> <span class="n">model_vgg16</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">)</span>
<span class="c1">#print(History.history.keys())
</span></code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">model_evaluation</span><span class="p">(</span><span class="n">History</span><span class="p">,</span> <span class="n">predIdxs</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span><span class="n">testX</span><span class="p">,</span><span class="n">testY</span><span class="p">)</span>
</code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/python-functions/">Python functions</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Madan Baduwal. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>